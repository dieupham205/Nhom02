@model IEnumerable<Tour>

@{
    ViewData["Title"] = "Danh sách Tour";
    ViewData["IsFullWidth"] = true;
}

<!-- ==================== TIÊU ĐỀ TRANG ==================== -->
<!-- Phần tiêu đề lớn ở đầu trang, cố định màu nền xanh đậm -->
<h1 class="text-center display-5 fw-bold text-white py-5 mb-0" 
    style="background:  #333a73;">
    Danh sách Tour
</h1>

<!-- ==================== NỘI DUNG CHÍNH ==================== -->
<!-- Toàn bộ nội dung nằm trong container fluid, nền sáng để dễ nhìn -->
<div class="container-fluid py-5 bg-light">
    <div class="container">
        <div class="row">
            <!-- ==================== BỘ LỌC BÊN TRÁI ==================== -->
            <!-- Sticky trên desktop, accordion trên mobile để tiết kiệm chỗ -->
            <div class="col-lg-3 mb-5">
                <div class="sticky-top" style="top: 20px;">
                    <!-- Bộ lọc desktop (card cố định) -->
                    <div class="card shadow-sm border-0 d-none d-lg-block" data-aos="fade-right" data-aos-duration="800">
                        <div class="card-body">
                            <h5 class="card-title fw-bold mb-4 text-primary">Bộ lọc tìm kiếm</h5>

                            <div class="mb-4">
                                <label class="form-label fw-semibold">Ngân sách</label>
                                <select id="filter-budget" class="form-select">
                                    <option value="all">Tất cả</option>
                                    <option value="under10">Dưới 10 triệu</option>
                                    <option value="10to20">10 - 20 triệu</option>
                                    <option value="20to50">20 - 50 triệu</option>
                                    <option value="over50">Trên 50 triệu</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-semibold">Điểm đến</label>
                                <select id="filter-destination" class="form-select">
                                    <option value="all">Tất cả</option>
                                    @foreach (var dest in Model.Select(t => t.Destination?.Name).Distinct().Where(n => n != null).OrderBy(n => n))
                                    {
                                        <option value="@dest">@dest</option>
                                    }
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-semibold">Thời gian</label>
                                <select id="filter-duration" class="form-select">
                                    <option value="all">Tất cả</option>
                                    <option value="short">Dưới 7 ngày</option>
                                    <option value="medium">7 - 14 ngày</option>
                                    <option value="long">Trên 14 ngày</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Bộ lọc mobile (accordion có thể thu gọn) -->
                    <div class="accordion d-lg-none" id="mobileFilter" data-aos="fade-up" data-aos-duration="800">
                        <div class="accordion-item border shadow-sm">
                            <h2 class="accordion-header">
                                <button class="accordion-button fw-bold" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#filterCollapse">
                                    <i class="fas fa-filter me-2"></i> Bộ lọc tìm kiếm
                                </button>
                            </h2>
                            <div id="filterCollapse" class="accordion-collapse collapse show">
                                <div class="accordion-body pt-0">
                                    <div class="mb-3"><label class="form-label fw-semibold">Ngân sách</label><select id="filter-budget-mobile" class="form-select"><option value="all">Tất cả</option><option value="under10">Dưới 10 triệu</option><option value="10to20">10 - 20 triệu</option><option value="20to50">20 - 50 triệu</option><option value="over50">Trên 50 triệu</option></select></div>
                                    <div class="mb-3"><label class="form-label fw-semibold">Điểm đến</label><select id="filter-destination-mobile" class="form-select"><option value="all">Tất cả</option>@foreach (var dest in Model.Select(t => t.Destination?.Name).Distinct().Where(n => n != null).OrderBy(n => n)) {<option value="@dest">@dest</option>}</select></div>
                                    <div class="mb-3"><label class="form-label fw-semibold">Thời gian</label><select id="filter-duration-mobile" class="form-select"><option value="all">Tất cả</option><option value="short">Dưới 7 ngày</option><option value="medium">7 - 14 ngày</option><option value="long">Trên 14 ngày</option></select></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== DANH SÁCH TOUR BÊN PHẢI ==================== -->
            <!-- Thanh tìm kiếm + danh sách tour chi tiết -->
            <div class="col-lg-9">
                <!-- Thanh tìm kiếm nhanh theo tên -->
                <div class="mb-5" data-aos="fade-left" data-aos-duration="800">
                    <div class="input-group input-group-lg shadow-sm">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" id="search-input" class="form-control border-start-0"
                               placeholder="Tìm tour theo tên, điểm đến, mã tour..." autocomplete="off">
                    </div>
                </div>

                <!-- Danh sách các tour -->
                <div id="tour-list">
                @foreach (var tour in Model)
                {
                    var totalDays = (tour.EndDate - tour.StartDate).Days + 1;
                    var totalNights = totalDays - 1;

                    // Giá ưu đãi
                    var originalPrice = tour.Price * 1.25m;

                    <div class="row g-5 mb-5 align-items-center border-bottom pb-5 tour-item"
                        data-price="@tour.Price"
                        data-destination="@(tour.Destination?.Name ?? "")"
                        data-duration="@totalDays"
                        data-name="@tour.Name"
                        data-aos="fade-up" data-aos-duration="800">

                        <!-- ========== ẢNH TOUR (THEO DESTINATION) ========== -->
                        <div class="col-md-5">
                            <img src="@tour.Destination?.ImageUrl"
                                class="img-fluid rounded-4 shadow-lg w-100"
                                style="height: 420px; object-fit: cover;"
                                alt="@tour.Destination?.Name">
                        </div>

                        <!-- ========== THÔNG TIN TOUR ========== -->
                        <div class="col-md-7">

                            <h2 class="h3 fw-bold mb-4">
                                @tour.Name
                            </h2>

                            <div class="row g-4 mb-4 text-muted">

                                <div class="col-sm-6">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    <strong>Điểm đến:</strong> @tour.Destination?.Name
                                </div>

                                <div class="col-sm-6">
                                    <i class="fas fa-clock me-2"></i>
                                    <strong>Thời gian:</strong>
                                    @totalDays Ngày @totalNights Đêm
                                </div>

                                <div class="col-sm-6">
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    <strong>Khởi hành:</strong>
                                    @tour.StartDate.ToString("dd/MM/yyyy")
                                </div>

                                <div class="col-sm-6">
                                    <i class="fas fa-users me-2"></i>
                                    <strong>Số lượng:</strong>
                                    Tối đa @tour.MaxParticipants khách
                                </div>

                            </div>

                            <!-- ========== GIÁ + CTA ========== -->
                            <div class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-4">

                                <div>
                                    <div class="text-muted text-decoration-line-through fs-5">
                                        @originalPrice.ToString("N0")đ
                                    </div>

                                <div class="fw-bold text-danger display-6">
                                        @tour.Price.ToString("N0")đ
                                </div>
                            </div>

                            <a asp-action="Details"
                                asp-route-id="@tour.TourId"
                                class="btn btn-primary rounded-pill px-5 py-3 fw-semibold">
                                Xem chi tiết <i class="fas fa-arrow-right ms-2"></i>
                            </a>

                        </div>
                    </div>
                </div>
                }

                </div>

                <!-- Thông báo khi không có tour nào phù hợp -->
                <div id="no-results" class="text-center py-5 d-none" data-aos="fade-in" data-aos-duration="800">
                    <i class="fas fa-search fa-4x text-muted mb-4"></i>
                    <h4 class="text-muted">Không tìm thấy tour nào phù hợp</h4>
                    <p class="text-muted">Hãy thử thay đổi từ khóa hoặc bộ lọc</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const tourItems = document.querySelectorAll('.tour-item');
        const tourList = document.getElementById('tour-list');
        const noResults = document.getElementById('no-results');

        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();

            const budget = (document.getElementById('filter-budget')?.value || document.getElementById('filter-budget-mobile')?.value || 'all');
            const destination = (document.getElementById('filter-destination')?.value || document.getElementById('filter-destination-mobile')?.value || 'all');
            const durationFilter = (document.getElementById('filter-duration')?.value || document.getElementById('filter-duration-mobile')?.value || 'all');

            let visibleCount = 0;

            tourItems.forEach(item => {
                const name = item.dataset.name.toLowerCase();
                const dest = item.dataset.destination.toLowerCase();
                const price = parseInt(item.dataset.price);
                const days = parseInt(item.dataset.duration);

                const matchesSearch = !searchTerm || name.includes(searchTerm) || dest.includes(searchTerm);

                let matchesBudget = true;
                if (budget === 'under10') matchesBudget = price < 10000000;
                else if (budget === '10to20') matchesBudget = price >= 10000000 && price < 20000000;
                else if (budget === '20to50') matchesBudget = price >= 20000000 && price < 50000000;
                else if (budget === 'over50') matchesBudget = price >= 50000000;

                const matchesDestination = destination === 'all' || dest === destination.toLowerCase();

                let matchesDuration = true;
                if (durationFilter === 'short') matchesDuration = days < 7;
                else if (durationFilter === 'medium') matchesDuration = days >= 7 && days <= 14;
                else if (durationFilter === 'long') matchesDuration = days > 14;

                if (matchesSearch && matchesBudget && matchesDestination && matchesDuration) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            if (visibleCount === 0) {
                noResults.classList.remove('d-none');
                tourList.classList.add('d-none');
            } else {
                noResults.classList.add('d-none');
                tourList.classList.remove('d-none');
            }
        }

        document.getElementById('search-input').addEventListener('input', applyFilters);
        ['filter-budget', 'filter-destination', 'filter-duration'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', applyFilters);
        });
        ['filter-budget-mobile', 'filter-destination-mobile', 'filter-duration-mobile'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', applyFilters);
        });

        applyFilters();
    </script>
}

<style>
    .btn-primary {
        background-color: #fba834;
        border: none;
        transition: all 0.3s ease;
    }
    .btn-primary:hover {
        background-color: #e6961e;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(251, 168, 52, 0.4);
    }
    .tour-item {
        transition: transform 0.3s ease;
    }
    .tour-item:hover {
        transform: translateY(-5px);
    }
    @@media (max-width: 991px) {
        .sticky-top {
            position: static !important;
        }
    }
    @@media (max-width: 767.98px) {
        .tour-item .row {
            flex-direction: column-reverse;
        }
        .tour-item img {
            height: 280px !important;
        }
        .btn-primary {
            width: 100%;
        }
        .accordion-button {
            background-color: #f8f9fa;
        }
    }
</style>
